---
phase: 01-quick-wins-securite
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - vite.config.ts
  - server/middleware/csp.ts
  - server/routes/csp.ts
  - server/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Content Security Policy est en place en mode report-only"
    - "Les violations CSP sont journalisées dans le serveur"
    - "Les balises <style> de Tailwind utilisent des nonces"
    - "La politique CSP autorise les fournisseurs OAuth (Google, Microsoft, Notion)"
  artifacts:
    - path: "vite.config.ts"
      provides: "Vite plugin for CSP nonce injection"
      contains: "cspPlugin or transformIndexHTML hook"
    - path: "server/middleware/csp.ts"
      provides: "CSP header middleware with nonce generation"
      exports: ["cspMiddleware()", "generateNonce()"]
    - path: "server/routes/csp.ts"
      provides: "CSP violation logging endpoint"
      exports: ["POST /csp-report"]
    - path: "server/index.ts"
      provides: "CSP middleware registration"
      contains: "app.use(cspMiddleware)"
  key_links:
    - from: "vite.config.ts"
      to: "index.html"
      via: "transformIndexHTML hook"
      pattern: "transformIndexHTML.*nonce"
    - from: "server/middleware/csp.ts"
      to: "response headers"
      via: "res.setHeader('Content-Security-Policy-Report-Only')"
      pattern: "Content-Security-Policy-Report-Only"
    - from: "server/routes/csp.ts"
      to: "logger"
      via: "Violation logging"
      pattern: "logger\\.warn.*CSP Violation"
---

<objective>
Implémenter une Content Security Policy pour protéger contre les attaques XSS

Purpose: Contrôler les ressources chargées par l'application et bloquer les scripts/styles non autorisés
Output: CSP en mode report-only avec journalisation des violations
</objective>

<execution_context>
@/home/orion/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/orion/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-quick-wins-securite/01-CONTEXT.md
@.planning/phases/01-quick-wins-securite/01-RESEARCH.md

# Existing Infrastructure
- Vite 7 pour le bundling
- Express server pour le proxy OAuth
- Tailwind CSS v4 pour les styles

# Pattern from CONTEXT.md (Decisions)
- **Deployment mode:** Report-only pour 1 semaine (pas de blocage immédiat)
- **Inline styles:** Utiliser des nonces pour les balises `<style>`
- **Policy strictness:** Modérée — autoriser app domain + CDNs + OAuth providers
- **Violation reporting:** Journaliser via logger infrastructure existant

# Dependencies from Plan 02
- None required (this plan is independent)
</context>

<tasks>

<task type="auto">
  <name>Créer le middleware CSP avec génération de nonce</name>
  <files>server/middleware/csp.ts</files>
  <action>
    Créer le fichier server/middleware/csp.ts:

    ```typescript
    import { Request, Response, NextFunction } from 'express';
    import { randomBytes } from 'crypto';
    import { logger } from '../src/lib/logger';

    export function generateNonce(): string {
      return randomBytes(16).toString('base64');
    }

    export function cspMiddleware(req: Request, res: Response, next: NextFunction): void {
      const nonce = generateNonce();

      // Stocker le nonce dans res.locals pour utilisation dans les templates
      (res as any).locals = (res as any).locals || {};
      (res as any).locals.nonce = nonce;

      // Politique CSP modérée avec nonces pour Tailwind
      const cspDirectives = [
        `default-src 'self'`,
        `script-src 'self' 'nonce-${nonce}'`,
        `style-src 'self' 'nonce-${nonce}'`,
        `img-src 'self' data: https:`,
        `font-src 'self' data:`,
        `connect-src 'self' https://accounts.google.com https://login.microsoftonline.com https://www.notionapi.com`,
        `frame-src https://accounts.google.com https://login.microsoftonline.com`,
        `object-src 'none'`,
        `base-uri 'self'`,
        `form-action 'self'`,
        `frame-ancestors 'none'`,
        `report-uri /csp-report`,
      ].join('; ');

      // Mode report-only pour commencer (1 semaine de collecte)
      res.setHeader('Content-Security-Policy-Report-Only', cspDirectives);

      // TODO: Après 1 semaine, décommenter pour enforcement:
      // res.setHeader('Content-Security-Policy', cspDirectives);

      next();
    }
    ```

    Installer le package crypto si nécessaire (normalement déjà disponible dans Node.js).
  </action>
  <verify>
    Le fichier existe et exporte les fonctions:
    ```bash
    grep -q "export function generateNonce" server/middleware/csp.ts && echo "OK"
    grep -q "export function cspMiddleware" server/middleware/csp.ts && echo "OK"
    ```

    Vérifier que le mode est report-only:
    ```bash
    grep "Content-Security-Policy-Report-Only" server/middleware/csp.ts
    ```
  </verify>
  <done>
    Middleware CSP créé avec génération de nonce et mode report-only
  </done>
</task>

<task type="auto">
  <name>Créer l'endpoint de rapport des violations CSP</name>
  <files>server/routes/csp.ts</files>
  <action>
    Créer le fichier server/routes/csp.ts:

    ```typescript
    import { Router } from 'express';
    import { logger } from '@/lib/logger';

    const router = Router();

    // Content-Type spécial pour les rapports CSP
    router.post('/csp-report', (req, res) => {
      try {
        const report = req.body;

        // Extraire les informations pertinentes du rapport
        const violation = {
          violatedDirective: report['csp-report']?.['violated-directive'] || 'unknown',
          blockedURI: report['csp-report']?.['blocked-uri'] || 'unknown',
          sourceFile: report['csp-report']?.['source-file'] || 'unknown',
          lineNumber: report['csp-report']?.['line-number'] || 'unknown',
          columnNumber: report['csp-report']?.['column-number'] || 'unknown',
        };

        logger.warn('CSP Violation detected:', {
          directive: violation.violatedDirective,
          blockedURI: violation.blockedURI,
          source: violation.sourceFile,
          line: violation.lineNumber,
        });

        // Répondre avec 204 No Content
        res.status(204).end();
      } catch (error) {
        logger.error('Error processing CSP report:', error);
        res.status(400).end();
      }
    });

    export default router;
    ```

    Ce endpoint recevra les rapports automatiques du navigateur en cas de violation CSP.
  </action>
  <verify>
    Le fichier existe et exporte le routeur:
    ```bash
    grep -q "router.post('/csp-report'" server/routes/csp.ts && echo "OK"
    grep -q "export default router" server/routes/csp.ts && echo "OK"
    ```

    Vérifier que les violations sont journalisées:
    ```bash
    grep "logger.warn.*CSP Violation" server/routes/csp.ts
    ```
  </verify>
  <done>
    Endpoint de rapport CSP créé avec journalisation des violations
  </done>
</task>

<task type="auto">
  <name>Enregistrer le middleware et la route CSP dans le serveur</name>
  <files>server/index.ts</files>
  <action>
    Dans server/index.ts:

    1. Importer le middleware CSP:
    ```typescript
    import { cspMiddleware } from './middleware/csp';
    import cspRoutes from './routes/csp';
    ```

    2. Enregistrer le middleware CSP avant les autres routes:
    ```typescript
    app.use(cspMiddleware);
    ```

    3. Enregistrer la route des rapports CSP:
    ```typescript
    app.use('/api', cspRoutes);
    ```

    Placer l'appel à cspMiddleware APRÈS cookie-parser mais AVANT les routes d'API.
  </action>
  <verify>
    Vérifier que le middleware est enregistré:
    ```bash
    grep "cspMiddleware" server/index.ts
    ```

    Vérifier que la route est enregistrée:
    ```bash
    grep "cspRoutes" server/index.ts
    ```
  </verify>
  <done>
    Middleware CSP et route de rapport enregistrés dans le serveur Express
  </done>
</task>

<task type="auto">
  <name>Créer un plugin Vite pour injecter les nonces dans les balises style</name>
  <files>vite.config.ts</files>
  <action>
    Dans vite.config.ts, ajouter un plugin pour injecter les nonces:

    ```typescript
    import { defineConfig } from 'vite';
    import react from '@vitejs/plugin-react';
    { crypto } = require('crypto');

    // Plugin CSP pour le développement
    function cspNoncePlugin() {
      return {
        name: 'vite-plugin-csp-nonce',
        enforce: 'pre',
        transformIndexHtml(html: string) {
          // Générer un nonce pour cette requête
          const nonce = crypto.randomBytes(16).toString('base64');

          // Injecter le CSP header en développement via meta tag
          const cspMeta = `<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'nonce-${nonce}'; style-src 'self' 'nonce-${nonce}'; connect-src 'self' https://accounts.google.com https://login.microsoftonline.com; report-uri /csp-report">`;

          // Injecter le nonce dans les balises script et style
          html = html.replace(
            /<script/g,
            `<script nonce="${nonce}"`
          );
          html = html.replace(
            /<style/g,
            `<style nonce="${nonce}"`
          );

          // Injecter le meta tag CSP
          html = html.replace(
            /<head>/,
            `<head>${cspMeta}`
          );

          return html;
        },
      };
    }

    export default defineConfig({
      plugins: [
        react(),
        cspNoncePlugin(),
      ],
      // ... reste de la config
    });
    ```

    Note: En production, le nonce sera généré par le middleware Express, pas par Vite.
  </action>
  <verify>
    Vérifier que le plugin est enregistré:
    ```bash
    grep "cspNoncePlugin" vite.config.ts
    ```

    Vérifier que les nonces sont injectés:
    ```bash
    grep "nonce=" vite.config.ts
    ```
  </verify>
  <done>
    Plugin Vite créé pour injecter les nonces CSP dans les balises script/style en développement
  </done>
</task>

</tasks>

<verification>
- [ ] Le middleware cspMiddleware génère un nonce crypto-random
- [ ] Le header CSP-Report-Only est défini avec tous les fournisseurs OAuth autorisés
- [ ] L'endpoint /csp-report journalise les violations avec logger.warn
- [ ] Le plugin Vite injecte les nonces dans index.html en développement
- [ ] Les balises <script> et <style> ont l'attribut nonce
- [ ] La politique CSP est en mode report-only (pas d'enforcement immédiat)
</verification>

<success_criteria>
**Observable:**
1. Dans les DevTools Network → Response Headers:
   ```
   Content-Security-Policy-Report-Only: default-src 'self'; script-src 'self' 'nonce-...'; ...
   ```

2. Les violations CSP apparaissent dans les logs serveur:
   ```
   [warn] CSP Violation detected: { directive: 'script-src', blockedURI: '...', source: '...' }
   ```

**Measurable:**
- 1 middleware CSP créé
- 1 route de rapport créé
- 1 plugin Vite créé
- CSP report-only actif (pas de blocage)
- Toutes les ressources autorisées (pas de violations légitimes bloquées)
</success_criteria>

<output>
After completion, create `.planning/phases/01-quick-wins-securite/01-03-SUMMARY.md`
</output>
